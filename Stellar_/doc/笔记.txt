资源	加载	渲染	场景管理	多线程	
================

SharedResourceServer  资源共享




WM4
VisibleObject  渲染前设置可见对象


vertexbuffer功能：
顶点格式FVF  VertexLayout	VertexDecl -- VertexLayout
顶点大小
复制顶点数据 Lock unlock
设备管理 IDirect3DVertexBuffer9



WM4
vertexbuffer:
顶点属性（Position、Normal、Color、Fog、BlendIndices、Coord...)
顶点数据
设备管理（在bindable中保存设备指针)


effect begin
commit
effect end

D3D9RenderDevice::BeginFrame
    FrameShader::Render					控制渲染多个FramePass
        FramePass::Render				渲染到rendertarget
	    // apply shader variables

	    D3D9RenderDevice::BeginPass
	    FrameBatch::Render				批次渲染，几个特效组合需要多次渲染。
		// apply shader variables

		BeginBatch
		RenderBatch				设置Technique,variable等，并循环渲染
		  GetVisibleModels			获取可见对象
		  GetVisibleModelNodes			为每个Model获取Nodes
		  SetFeatureBits			设置technique
		  ApplySharedState			应用着色变量的状态
		  SelectActiveVariation			激活technique

		  GetVisibleModelNodeInstances		获得可见对象的所有实例，循环渲染所有实例
		  ApplyState				应用实例的着色变量
		  Render				渲染实例

		EndBatch
	    D3D9RenderDevice::EndPass
D3D9RenderDevice::EndFrame




WM4渲染过程

Polylines::OnIdle
  Renderer::DrawScene		获得可见对象
    Renderer::Draw		渲染
      SetGlobalState		设置全局状态（固定管线）
      EnableIBuffer		设置索引缓冲
      循环应用所有的效果（如果有多个）
      ApplyEffect		应用效果并渲染
        SetGlobalState		为每个EffectShader设置渲染状态（固定管线）
	EnableVProgram		顶点着色
	EnablePProgram		像素着色
	EnableTexture		设置纹理
	EnableVBuffer		顶点缓冲(这里还要从Attributes获取FVF）
	DrawElements		真正渲染
	...





资源建立方式,具体见N3的ResourceManager
ResourceManager
    SharedResourceServer
        Resource

ResourceManager::CreateResource(const Rtti& resType, const string resName)
ResourceManager::CreateResource(const Rtti& resType, const ResourceId& resId)
{
    SharedResourceServer::CreateSharedResource(resId, resClass, resLoaderClass)
    load resource
}

vertex layout（FVF）设置方法:
Array<VertexComponent> vertexComponents;
vertexComponents.Append(VertexComponent(VertexComponent::Position, 0, VertexComponent::Float3));
vertexComponents.Append(VertexComponent(VertexComponent::TexCoord, 0, VertexComponent::Float2));
VertexBuffer.Setup(vertexComponents);


shader应用:

shader
    constants
    program

EnableVProgram
    SetVertexShader()
    process the sampler information		设置纹理采样信息，指定采样类型、纹理编号
    process the render constants		获取全局着色变量值，并设置到指定寄存器
    process the numerical constants
    process the user-defined constants
EnablePProgram
    步聚同上
EnableTexture V
    Anisotropic filtering value
	D3DSAMP_MAXANISOTROPY
    Set the filter mode
	D3DSAMP_MAGFILTER
    Set the mipmap mode
	D3DSAMP_MINFILTER
	D3DSAMP_MIPFILTER
    Set the border color (for clamp to border)
	D3DSAMP_BORDERCOLOR
    Set Address mode
	D3DSAMP_ADDRESSU
	D3DSAMP_ADDRESSV
	D3DSAMP_ADDRESSW   如果是3d采样
    SetTexture
EnableTexture P
    同上
OnEnableVBuffer
    SetStreamSource
    SetVertexDeclaration
Draw


Spatial
    Local		本地坐标
    World		世界坐标
    WorldBound		世界包围盒
    CullingMode		栋选方式
    m_pkParent		父指针
    m_kGlobalStates	全局渲染状态（数组）
    m_kLights		灯光状态（数组）
    m_kEffects		特效状态（数组）  多次着色过程

Geometry 继承自Spatial
    VertexBufferPtr	顶点缓冲
    IndexBufferPtr	索引缓冲
    BoundingVolumePtr	模型包围盒
    LightingEffectPtr	光照效果
    GeometryType     	PrimitiveTopology  渲染方式(LineList、TriangleStrip等)
    GlobalState    	全局渲染状态(alpha,cull,material,zbuffer等等)
    
特殊的对象可以继承Geometry来实现特殊化。

Node 继承自Spatial
    m_kChild



GeometryInstance
    PrimitiveGroup			记录渲染顶点的开始位置和数量等信息。
    Geometry				具体数据
    BoundingVolumePtr			子模型包围盒
    vector<ShaderVariableInstance>	shader variable  instance 多个变量
    vector<shader>			effect 多个shader
    



Renderer::DrawScene
    循环处理所有可见对象
    Draw(Geometry*)
        SetGlobalState
        SetWorldTransformation		从Draw参数传进一个Geometry，在这里更新世界矩阵，着色所需
	EnableIBuffer			用Geometry设置索引缓冲
	获得效果文件(数组)		Start,Quantity,效果文件从Start位置开始取Quantity个数量渲染
	


使用bsp：
WM中BSP将空间分割成正、负和分割线三部份。
怎么判断视截体在正面还是负面？Plane类有个成员函数WhichSide，判断输入的点是正边还是负边，Camera类
有个成员函数WhichSide用于测试视截体的八个点在哪面，如果八个点都在正面，则返回正，如果八个点都在负
面，则返回负面，如果有些在正面有些在负面，就返回0.


The root of the BSP tree is a
special node that helps determine in which leaf region the eye point is.

BSP树的根节点是一个特殊的节点，它用于决定当前眼睛在哪个叶子范围。




    